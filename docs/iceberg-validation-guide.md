# Iceberg Table Validation Guide

## Overview

This guide explains how to validate Iceberg tables generated by the DataTransfer.Iceberg library using industry-standard tools like PyIceberg and DuckDB.

## Prerequisites

### Option 1: PyIceberg (Python)

```bash
# Install Python 3.8+
sudo apt-get install python3 python3-pip

# Install PyIceberg
pip3 install pyiceberg

# Optional: Install pandas for data analysis
pip3 install pandas
```

### Option 2: DuckDB (SQL Interface)

```bash
# Download and install DuckDB CLI
wget https://github.com/duckdb/duckdb/releases/download/v0.10.0/duckdb_cli-linux-amd64.zip
unzip duckdb_cli-linux-amd64.zip
sudo mv duckdb /usr/local/bin/

# Or install via package manager
sudo apt-get install duckdb
```

## Validation Methods

### 1. PyIceberg Validation

PyIceberg is the official Python library for Apache Iceberg tables.

**Validation Script: `scripts/validate-with-pyiceberg.py`**

```python
#!/usr/bin/env python3
"""
Validates Iceberg tables using PyIceberg
"""
from pyiceberg.catalog import load_catalog
from pyiceberg.exceptions import NoSuchTableError
import sys

def validate_iceberg_table(warehouse_path, table_name):
    """
    Validates an Iceberg table created by DataTransfer.Iceberg

    Checks:
    - Table metadata is readable
    - Schema is valid
    - Field IDs are preserved
    - Snapshots exist
    - Parquet files are readable
    """
    try:
        # Load filesystem catalog
        catalog = load_catalog(
            "local",
            **{
                "type": "filesystem",
                "warehouse": warehouse_path,
            }
        )

        # Load table
        table = catalog.load_table(table_name)

        print(f"✓ Successfully loaded table: {table_name}")
        print(f"  Location: {table.location()}")
        print(f"  Format version: {table.metadata.format_version}")
        print(f"  Table UUID: {table.metadata.table_uuid}")

        # Validate schema
        schema = table.schema()
        print(f"\n✓ Schema validation:")
        print(f"  Schema ID: {schema.schema_id}")
        print(f"  Field count: {len(schema.fields)}")

        for field in schema.fields:
            print(f"    - Field {field.field_id}: {field.name} ({field.field_type})")
            if field.field_id <= 0:
                print(f"      ⚠️  WARNING: Invalid field ID {field.field_id}")
                return False

        # Validate snapshots
        snapshots = list(table.metadata.snapshots)
        if not snapshots:
            print("\n⚠️  WARNING: No snapshots found")
        else:
            print(f"\n✓ Snapshots: {len(snapshots)}")
            for snapshot in snapshots:
                print(f"  - Snapshot {snapshot.snapshot_id}")
                print(f"    Timestamp: {snapshot.timestamp_ms}")

        # Validate current snapshot
        current_snapshot = table.metadata.current_snapshot()
        if current_snapshot:
            print(f"\n✓ Current snapshot: {current_snapshot.snapshot_id}")

            # Try to scan table
            scan = table.scan()
            df = scan.to_pandas()
            print(f"\n✓ Data scan successful:")
            print(f"  Record count: {len(df)}")
            print(f"  Columns: {list(df.columns)}")

            if len(df) > 0:
                print(f"\n  Sample data (first 5 rows):")
                print(df.head())
        else:
            print("\n⚠️  No current snapshot")

        print(f"\n✅ Table '{table_name}' is valid and compatible with PyIceberg")
        return True

    except NoSuchTableError:
        print(f"❌ Table not found: {table_name}")
        return False
    except Exception as e:
        print(f"❌ Validation failed: {e}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("Usage: python3 validate-with-pyiceberg.py <warehouse_path> <table_name>")
        print("Example: python3 validate-with-pyiceberg.py /tmp/iceberg-warehouse test_table")
        sys.exit(1)

    warehouse = sys.argv[1]
    table = sys.argv[2]

    success = validate_iceberg_table(warehouse, table)
    sys.exit(0 if success else 1)
```

### 2. DuckDB Validation

DuckDB has native Iceberg support and can read Iceberg tables directly.

**Validation Script: `scripts/validate-with-duckdb.sql`**

```sql
-- Load Iceberg extension
INSTALL iceberg;
LOAD iceberg;

-- Read Iceberg table (replace paths as needed)
-- DuckDB requires the full path to the table metadata file
SELECT * FROM iceberg_scan('/path/to/warehouse/table_name/metadata/v1.metadata.json');

-- Validate schema
DESCRIBE iceberg_scan('/path/to/warehouse/table_name/metadata/v1.metadata.json');

-- Count records
SELECT COUNT(*) as record_count
FROM iceberg_scan('/path/to/warehouse/table_name/metadata/v1.metadata.json');

-- Sample data
SELECT *
FROM iceberg_scan('/path/to/warehouse/table_name/metadata/v1.metadata.json')
LIMIT 10;
```

**DuckDB Command Line Usage:**

```bash
# Interactive validation
duckdb

# Or run SQL file
duckdb < scripts/validate-with-duckdb.sql

# Or inline
duckdb -c "
INSTALL iceberg;
LOAD iceberg;
SELECT * FROM iceberg_scan('/tmp/iceberg-warehouse/test_table/metadata/v1.metadata.json');
"
```

### 3. Manual Validation

You can manually inspect Iceberg tables using standard tools:

**Check Directory Structure:**
```bash
# Expected structure
tree /tmp/iceberg-warehouse/test_table/

# Should show:
# test_table/
# ├── data/
# │   └── data-0001.parquet
# └── metadata/
#     ├── v1.metadata.json
#     ├── version-hint.txt
#     ├── snap-<snapshot-id>.avro
#     └── manifest-<uuid>.avro
```

**Validate JSON Metadata:**
```bash
# Check metadata is valid JSON
jq . /tmp/iceberg-warehouse/test_table/metadata/v1.metadata.json

# Extract schema
jq '.schemas[0]' /tmp/iceberg-warehouse/test_table/metadata/v1.metadata.json

# Check field IDs
jq '.schemas[0].fields[] | {id, name, type}' /tmp/iceberg-warehouse/test_table/metadata/v1.metadata.json
```

**Inspect Parquet Files:**
```bash
# Install parquet-tools if not available
pip3 install parquet-tools

# View schema (should include field-id metadata)
parquet-tools schema /tmp/iceberg-warehouse/test_table/data/data-0001.parquet

# View metadata
parquet-tools meta /tmp/iceberg-warehouse/test_table/data/data-0001.parquet

# Show first few rows
parquet-tools show /tmp/iceberg-warehouse/test_table/data/data-0001.parquet
```

**Inspect Avro Manifest Files:**
```bash
# Install avro-tools if not available
sudo apt-get install avro-tools

# View manifest schema
avro-tools getschema /tmp/iceberg-warehouse/test_table/metadata/manifest-*.avro

# View manifest data
avro-tools tojson /tmp/iceberg-warehouse/test_table/metadata/manifest-*.avro

# View manifest list
avro-tools tojson /tmp/iceberg-warehouse/test_table/metadata/snap-*.avro
```

## Expected Validation Results

### ✅ Valid Iceberg Table Checklist

- [ ] Table metadata JSON file exists and is valid
- [ ] `format-version` is 2
- [ ] `table-uuid` is a valid UUID
- [ ] Schema has sequential field IDs (1, 2, 3, ...)
- [ ] All fields have `id`, `name`, `required`, and `type`
- [ ] Snapshots array is not empty
- [ ] `current-snapshot-id` matches a snapshot in the snapshots array
- [ ] `last-sequence-number` is 1 for initial commit
- [ ] Manifest list Avro file exists
- [ ] Manifest Avro file exists and references data files
- [ ] Parquet data files exist in `data/` directory
- [ ] Parquet files have embedded field-id metadata (critical for schema evolution)
- [ ] Record counts match across metadata, manifest, and Parquet files

## Common Issues

### Issue: PyIceberg Can't Read Table

**Symptoms:**
```
pyiceberg.exceptions.NoSuchTableError: Table does not exist
```

**Resolution:**
- Ensure warehouse path is correct
- Check that `metadata/version-hint.txt` exists and contains "1"
- Verify `metadata/v1.metadata.json` is valid JSON

### Issue: DuckDB Scan Fails

**Symptoms:**
```
Error: Invalid input exception - Iceberg metadata version not supported
```

**Resolution:**
- Update DuckDB to latest version (0.10.0+)
- Ensure `format-version` in metadata is 2
- Check that manifest list file is valid Avro

### Issue: Missing Field IDs in Parquet

**Symptoms:**
- PyIceberg loads but schema evolution doesn't work
- Field IDs are null or -1

**Resolution:**
- This indicates ParquetSharp is not embedding field-ids properly
- Verify `IcebergParquetWriter.BuildIcebergCompliantSchema()` uses `fieldId` parameter
- Use `parquet-tools schema` to verify field-id metadata exists

## Integration Tests

The DataTransfer.Iceberg.Tests project includes integration tests that validate:
- Complete Iceberg table structure
- Metadata JSON generation
- Manifest/manifest-list generation
- Parquet file writing with field-ids
- Catalog operations

Run tests with:
```bash
dotnet test tests/DataTransfer.Iceberg.Tests
```

## Production Validation Workflow

1. **Generate Test Table** (using IcebergTableWriter or SqlServerToIcebergExporter)
2. **Run PyIceberg Validation** (checks compatibility)
3. **Run DuckDB Validation** (checks SQL interoperability)
4. **Manual Inspection** (spot-check metadata and data files)
5. **Schema Evolution Test** (add/drop columns, verify field-ids work)

## Continuous Integration

For CI/CD pipelines, add validation steps:

```yaml
# .github/workflows/iceberg-validation.yml
name: Iceberg Validation

on: [push, pull_request]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install PyIceberg
        run: pip install pyiceberg pandas

      - name: Run .NET tests
        run: dotnet test

      - name: Generate test Iceberg table
        run: dotnet run --project tests/DataTransfer.Iceberg.Tests.Integration

      - name: Validate with PyIceberg
        run: python3 scripts/validate-with-pyiceberg.py /tmp/iceberg-test-warehouse test_table
```

## References

- [Apache Iceberg Specification](https://iceberg.apache.org/spec/)
- [PyIceberg Documentation](https://py.iceberg.apache.org/)
- [DuckDB Iceberg Extension](https://duckdb.org/docs/extensions/iceberg)
- [Parquet Format Specification](https://parquet.apache.org/docs/)
- [Apache Avro Specification](https://avro.apache.org/docs/current/spec.html)

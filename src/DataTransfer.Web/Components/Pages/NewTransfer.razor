@page "/transfer/new"
@using DataTransfer.Core.Models
@using DataTransfer.Web.Services
@using DataTransfer.Web.Models
@using DataTransfer.Configuration.Models
@using DataTransfer.Configuration.Services
@inject TransferExecutionService ExecutionService
@inject DatabaseMetadataService MetadataService
@inject ParquetFileService ParquetFileService
@inject TransferProfileService ProfileService
@inject NavigationManager Navigation
@inject IConfiguration Configuration
@rendermode InteractiveServer

<PageTitle>New Transfer</PageTitle>

<h1>Configure New Transfer</h1>

@* Profile Loading Section *@
<div class="card mt-3 border-info">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-8">
                <label class="form-label fw-bold">Load from Saved Profile</label>
                <select id="profileSelector" @bind="_selectedProfileId" @bind:after="OnProfileSelected" class="form-select">
                    <option value="">-- Start from scratch --</option>
                    @foreach (var profile in _availableProfiles)
                    {
                        <option value="@profile.ProfileId">@profile.ProfileName @(string.IsNullOrEmpty(profile.Description) ? "" : $"- {profile.Description}")</option>
                    }
                </select>
            </div>
            <div class="col-md-4">
                @if (!string.IsNullOrEmpty(_selectedProfileId))
                {
                    <div class="alert alert-success mb-0 mt-3">
                        <small><strong>✓ Profile Loaded</strong></small>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="card mt-3">
    <div class="card-body">
        <EditForm Model="@_config" OnValidSubmit="@HandleSubmit" FormName="transferForm">
            <div class="mb-3">
                <label class="form-label">Transfer Type</label>
                <InputSelect @bind-Value="_config.TransferType" class="form-select" @onchange="OnTransferTypeChanged">
                    <option value="@TransferType.SqlToParquet">SQL Server → Parquet (Export)</option>
                    <option value="@TransferType.ParquetToSql">Parquet → SQL Server (Import)</option>
                </InputSelect>
            </div>

            @if (_config.TransferType == TransferType.SqlToParquet)
            {
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">SQL Server Source</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Connection Preset</label>
                            <div class="input-group">
                                <select id="connectionPreset" @bind="_selectedPreset" @bind:after="OnPresetChanged" class="form-select" title="Select a saved connection or choose Custom">
                                    <option value="">Custom</option>
                                    @foreach (var preset in _connectionPresets)
                                    {
                                        <option value="@preset.Name">@preset.Name</option>
                                    }
                                </select>
                                <button type="button" class="btn btn-outline-secondary" @onclick="TestSourceConnection" disabled="@_isTestingConnection" title="Verify connection to SQL Server">
                                    @if (_isTestingConnection)
                                    {
                                        <span class="spinner-border spinner-border-sm"></span>
                                    }
                                    else
                                    {
                                        <span>Test Connection</span>
                                    }
                                </button>
                            </div>
                            <div class="form-text text-muted">
                                <small>Select a preset connection or enter a custom connection string below</small>
                            </div>
                            @if (!string.IsNullOrEmpty(_connectionTestMessage))
                            {
                                <div class="form-text @(_connectionTestSuccess ? "text-success" : "text-danger")">
                                    @_connectionTestMessage
                                </div>
                            }
                        </div>

                        <div id="recentConnections" class="mb-3" style="@(_recentConnections.Any() ? "" : "display: none;")">
                            <label class="form-label text-muted small">Recent Connections</label>
                            <div class="d-flex flex-wrap gap-1">
                                @foreach (var recent in _recentConnections.Take(3))
                                {
                                    <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => LoadRecentConnection(recent)">
                                        <span class="bi bi-clock-history me-1"></span>@recent
                                    </button>
                                }
                            </div>
                        </div>

                        @if (_selectedPreset == "")
                        {
                            <div class="mb-3">
                                <label class="form-label">Connection String</label>
                                <input @bind="_sourceConnectionString" class="form-control" placeholder="Server=localhost;Database=MyDb;Integrated Security=true;" title="Enter SQL Server connection string" />
                                <div class="form-text text-muted">
                                    <small>Example: Server=localhost;Database=MyDb;User Id=sa;Password=***;TrustServerCertificate=true</small>
                                </div>
                            </div>
                        }

                        @if (_connectionTestSuccess || !string.IsNullOrEmpty(_selectedPreset))
                        {
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Database</label>
                                    <select id="database" @bind="_sourceDatabase" @bind:after="OnDatabaseChanged" class="form-select" disabled="@_isLoadingDatabases" title="Select target database">
                                        <option value="">-- Select Database --</option>
                                        @foreach (var db in _availableDatabases)
                                        {
                                            <option value="@db">@db</option>
                                        }
                                    </select>
                                    @if (_isLoadingDatabases)
                                    {
                                        <div class="form-text"><span class="spinner-border spinner-border-sm"></span> Loading databases...</div>
                                    }
                                    else if (_availableDatabases.Any())
                                    {
                                        <div class="form-text text-muted"><small>@_availableDatabases.Count database(s) available</small></div>
                                    }
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Schema</label>
                                    <select id="schema" @bind="_sourceSchema" @bind:after="OnSchemaChanged" class="form-select" disabled="@(string.IsNullOrEmpty(_sourceDatabase) || _isLoadingSchemas)" title="Select schema (usually 'dbo')">
                                        <option value="">-- Select Schema --</option>
                                        @foreach (var schema in _availableSchemas)
                                        {
                                            <option value="@schema">@schema</option>
                                        }
                                    </select>
                                    @if (_isLoadingSchemas)
                                    {
                                        <div class="form-text"><span class="spinner-border spinner-border-sm"></span> Loading schemas...</div>
                                    }
                                    else if (_availableSchemas.Any())
                                    {
                                        <div class="form-text text-muted"><small>@_availableSchemas.Count schema(s) available</small></div>
                                    }
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Table</label>
                                    <input id="tableSearch" type="text" @bind="_tableSearchText" @bind:event="oninput" class="form-control form-control-sm mb-1" placeholder="Search tables..." style="@(_availableTables.Any() ? "" : "display: none;")" title="Filter tables by name" />
                                    <select id="table" @bind="_sourceTable" class="form-select" disabled="@(string.IsNullOrEmpty(_sourceSchema) || _isLoadingTables)" title="Select table or view to transfer">
                                        <option value="">-- Select Table --</option>
                                        @foreach (var table in FilteredTables)
                                        {
                                            <option value="@table.Name">@table.FullName</option>
                                        }
                                    </select>
                                    @if (_isLoadingTables)
                                    {
                                        <div class="form-text"><span class="spinner-border spinner-border-sm"></span> Loading tables...</div>
                                    }
                                    else if (_availableTables.Any() && !FilteredTables.Any())
                                    {
                                        <div class="form-text text-muted">No tables match "@_tableSearchText"</div>
                                    }
                                    else if (_availableTables.Any())
                                    {
                                        <div class="form-text text-muted"><small>@FilteredTables.Count() of @_availableTables.Count table(s)</small></div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            @if (_config.TransferType == TransferType.ParquetToSql)
            {
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Parquet Source</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Parquet File</label>
                            <div class="d-flex gap-2 align-items-start">
                                <div class="flex-grow-1">
                                    <select id="parquetFile" @bind="_sourceParquetPath" class="form-select" title="Select Parquet file to import">
                                        <option value="">-- Select Parquet File --</option>
                                        @foreach (var file in _availableParquetFiles)
                                        {
                                            <option value="@file.RelativePath">@file.DisplayName</option>
                                        }
                                    </select>
                                    @if (_availableParquetFiles.Any())
                                    {
                                        <div class="form-text text-muted">
                                            <small>@_availableParquetFiles.Count file(s) available in parquet-files directory</small>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="form-text text-warning">
                                            <small>⚠️ No Parquet files found. Export some data using SQL→Parquet first.</small>
                                        </div>
                                    }
                                </div>
                                <button type="button" class="btn btn-outline-secondary" @onclick="RefreshParquetFiles" title="Refresh file list">
                                    <span class="bi bi-arrow-clockwise"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }

            @if (_config.TransferType == TransferType.ParquetToSql)
            {
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">SQL Server Destination</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Connection Preset</label>
                            <div class="input-group">
                                <select id="destConnectionPreset" @bind="_destSelectedPreset" @bind:after="OnDestPresetChanged" class="form-select" title="Select a saved connection or choose Custom">
                                    <option value="">Custom</option>
                                    @foreach (var preset in _connectionPresets)
                                    {
                                        <option value="@preset.Name">@preset.Name</option>
                                    }
                                </select>
                                <button type="button" class="btn btn-outline-secondary" @onclick="TestDestConnection" disabled="@_isTestingDestConnection" title="Verify connection to SQL Server">
                                    @if (_isTestingDestConnection)
                                    {
                                        <span class="spinner-border spinner-border-sm"></span>
                                    }
                                    else
                                    {
                                        <span>Test Connection</span>
                                    }
                                </button>
                            </div>
                            <div class="form-text text-muted">
                                <small>Select a preset connection or enter a custom connection string below</small>
                            </div>
                            @if (!string.IsNullOrEmpty(_destConnectionTestMessage))
                            {
                                <div class="form-text @(_destConnectionTestSuccess ? "text-success" : "text-danger")">
                                    @_destConnectionTestMessage
                                </div>
                            }
                        </div>

                        @if (string.IsNullOrEmpty(_destSelectedPreset))
                        {
                            <div class="mb-3">
                                <label class="form-label">Connection String</label>
                                <input @bind="_destConnectionString" class="form-control" placeholder="Server=localhost;Database=MyDb;Integrated Security=true;" title="Enter SQL Server connection string" />
                                <div class="form-text text-muted">
                                    <small>Example: Server=localhost;Database=MyDb;User Id=sa;Password=***;TrustServerCertificate=true</small>
                                </div>
                            </div>
                        }

                        @if (_destConnectionTestSuccess && _destAvailableDatabases.Any())
                        {
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Database</label>
                                    <select id="destDatabase" @bind="_destDatabase" @bind:after="OnDestDatabaseChanged" class="form-select" disabled="@_isLoadingDestDatabases" title="Select target database">
                                        <option value="">-- Select Database --</option>
                                        @foreach (var db in _destAvailableDatabases)
                                        {
                                            <option value="@db">@db</option>
                                        }
                                    </select>
                                    @if (_isLoadingDestDatabases)
                                    {
                                        <div class="form-text"><span class="spinner-border spinner-border-sm"></span> Loading databases...</div>
                                    }
                                    else if (_destAvailableDatabases.Any())
                                    {
                                        <div class="form-text text-muted"><small>@_destAvailableDatabases.Count database(s) available</small></div>
                                    }
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Schema</label>
                                    <select id="destSchema" @bind="_destSchema" @bind:after="OnDestSchemaChanged" class="form-select" disabled="@(string.IsNullOrEmpty(_destDatabase) || _isLoadingDestSchemas)" title="Select schema (usually 'dbo')">
                                        <option value="">-- Select Schema --</option>
                                        @foreach (var schema in _destAvailableSchemas)
                                        {
                                            <option value="@schema">@schema</option>
                                        }
                                    </select>
                                    @if (_isLoadingDestSchemas)
                                    {
                                        <div class="form-text"><span class="spinner-border spinner-border-sm"></span> Loading schemas...</div>
                                    }
                                    else if (_destAvailableSchemas.Any())
                                    {
                                        <div class="form-text text-muted"><small>@_destAvailableSchemas.Count schema(s) available</small></div>
                                    }
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Table</label>
                                    <select id="destTable" @bind="_destTable" class="form-select" disabled="@(string.IsNullOrEmpty(_destSchema) || _isLoadingDestTables)" title="Select target table">
                                        <option value="">-- Select Table --</option>
                                        @foreach (var table in _destAvailableTables)
                                        {
                                            <option value="@table.Name">@table.FullName</option>
                                        }
                                    </select>
                                    @if (_isLoadingDestTables)
                                    {
                                        <div class="form-text"><span class="spinner-border spinner-border-sm"></span> Loading tables...</div>
                                    }
                                    else if (_destAvailableTables.Any())
                                    {
                                        <div class="form-text text-muted"><small>@_destAvailableTables.Count table(s) available</small></div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            @if (_config.TransferType == TransferType.SqlToParquet)
            {
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Parquet Destination</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Parquet File Name</label>
                            <input @bind="_destParquetPath" class="form-control" placeholder="export_data.parquet" />
                            <div class="form-text">File will be created in parquet-files directory with date partitioning</div>
                        </div>
                    </div>
                </div>
            }

            <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                <button type="button" class="btn btn-outline-primary" @onclick="ShowSaveProfileDialog" disabled="@_isProcessing">
                    <span class="bi bi-save me-2"></span>
                    <span>Save as Profile</span>
                </button>
                <button type="submit" class="btn btn-primary btn-lg" disabled="@_isProcessing">
                    @if (_isProcessing)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        <span>Processing...</span>
                    }
                    else
                    {
                        <span class="bi bi-play-circle me-2"></span>
                        <span>Execute Transfer</span>
                    }
                </button>
            </div>
        </EditForm>
    </div>
</div>

@if (_isProcessing)
{
    <div class="alert alert-info mt-3">
        <h5>Transfer in Progress</h5>
        <p>Transfer ID: <code>@_currentTransferId</code></p>
        <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(_resultMessage))
{
    <div class="alert @(_transferSuccess ? "alert-success" : "alert-danger") mt-3">
        <h5>@(_transferSuccess ? "Transfer Completed Successfully" : "Transfer Failed")</h5>
        <p>@_resultMessage</p>
    </div>
}

@* Save Profile Dialog *@
@if (_showSaveProfileDialog)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Save Transfer Profile</h5>
                    <button type="button" class="btn-close" @onclick="CloseSaveProfileDialog"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Profile Name *</label>
                        <input id="profileName" @bind="_newProfileName" class="form-control" placeholder="Daily Orders Extract" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea @bind="_newProfileDescription" class="form-control" rows="2" placeholder="Extracts last 30 days of orders for UAT testing"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tags (comma-separated)</label>
                        <input @bind="_newProfileTags" class="form-control" placeholder="orders, daily, uat" />
                    </div>
                    @if (!string.IsNullOrEmpty(_profileSaveMessage))
                    {
                        <div class="alert @(_profileSaveSuccess ? "alert-success" : "alert-danger")">
                            @_profileSaveMessage
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseSaveProfileDialog">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveProfile" disabled="@string.IsNullOrWhiteSpace(_newProfileName)">
                        <span class="bi bi-save me-2"></span>Save Profile
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}

@code {
    private TransferConfiguration _config = new();
    private bool _isProcessing;
    private string? _currentTransferId;
    private string? _resultMessage;
    private bool _transferSuccess;

    // Source fields
    private string _sourceConnectionString = "";
    private string _sourceDatabase = "";
    private string _sourceSchema = "";
    private string _sourceTable = "";
    private string _sourceParquetPath = "";

    // Destination fields
    private string _destConnectionString = "";
    private string _destDatabase = "";
    private string _destSchema = "dbo";
    private string _destTable = "";
    private string _destParquetPath = "";

    // Connection preset and metadata fields
    private List<ConnectionPreset> _connectionPresets = new();
    private string _selectedPreset = "";
    private bool _isTestingConnection;
    private bool _connectionTestSuccess;
    private string? _connectionTestMessage;

    // Cascading dropdown state
    private List<string> _availableDatabases = new();
    private List<string> _availableSchemas = new();
    private List<TableInfo> _availableTables = new();
    private bool _isLoadingDatabases;
    private bool _isLoadingSchemas;
    private bool _isLoadingTables;

    // Phase 3: UX enhancements
    private string _tableSearchText = "";
    private List<string> _recentConnections = new();
    private IEnumerable<TableInfo> FilteredTables => string.IsNullOrWhiteSpace(_tableSearchText)
        ? _availableTables
        : _availableTables.Where(t => t.Name.Contains(_tableSearchText, StringComparison.OrdinalIgnoreCase) ||
                                       t.Type.Contains(_tableSearchText, StringComparison.OrdinalIgnoreCase));

    // Parquet file selection
    private List<ParquetFileInfo> _availableParquetFiles = new();

    // Destination cascading dropdown state
    private string _destSelectedPreset = "";
    private bool _isTestingDestConnection;
    private bool _destConnectionTestSuccess;
    private string? _destConnectionTestMessage;
    private List<string> _destAvailableDatabases = new();
    private List<string> _destAvailableSchemas = new();
    private List<TableInfo> _destAvailableTables = new();
    private bool _isLoadingDestDatabases;
    private bool _isLoadingDestSchemas;
    private bool _isLoadingDestTables;

    // Profile management fields
    private List<TransferProfile> _availableProfiles = new();
    private string _selectedProfileId = "";
    private bool _showSaveProfileDialog;
    private string _newProfileName = "";
    private string? _newProfileDescription;
    private string? _newProfileTags;
    private bool _profileSaveSuccess;
    private string? _profileSaveMessage;

    protected override async Task OnInitializedAsync()
    {
        // Load available profiles
        _availableProfiles = await ProfileService.GetAllProfilesAsync();
        await base.OnInitializedAsync();
    }

    protected override void OnInitialized()
    {
        // Load connection presets from configuration
        var connectionStrings = Configuration.GetSection("ConnectionStrings");
        foreach (var item in connectionStrings.GetChildren())
        {
            _connectionPresets.Add(new ConnectionPreset
            {
                Name = item.Key,
                ConnectionString = item.Value ?? ""
            });
        }

        // Load recent connections from localStorage (simulated with empty list for now)
        // In a real implementation, this would use JSInterop to access localStorage
        _recentConnections = new List<string>();

        // Load available Parquet files
        RefreshParquetFiles();
    }

    private void RefreshParquetFiles()
    {
        _availableParquetFiles = ParquetFileService.GetAvailableParquetFiles();
    }

    private async Task LoadRecentConnection(string connectionString)
    {
        _selectedPreset = "";
        _sourceConnectionString = connectionString;
        await TestSourceConnection();
    }

    private void SaveToRecentConnections(string connectionString)
    {
        if (string.IsNullOrWhiteSpace(connectionString))
            return;

        // Remove if already exists
        _recentConnections.Remove(connectionString);

        // Add to front
        _recentConnections.Insert(0, connectionString);

        // Keep only last 5
        if (_recentConnections.Count > 5)
        {
            _recentConnections = _recentConnections.Take(5).ToList();
        }

        // In a real implementation, save to localStorage using JSInterop
    }

    private void OnTransferTypeChanged(ChangeEventArgs e)
    {
        _resultMessage = null;
        ResetSourceFields();
    }

    private void ResetSourceFields()
    {
        _selectedPreset = "";
        _sourceConnectionString = "";
        _sourceDatabase = "";
        _sourceSchema = "";
        _sourceTable = "";
        _connectionTestSuccess = false;
        _connectionTestMessage = null;
        _availableDatabases.Clear();
        _availableSchemas.Clear();
        _availableTables.Clear();
    }

    private async Task OnPresetChanged()
    {
        _connectionTestMessage = null;
        _connectionTestSuccess = false;
        _availableDatabases.Clear();
        _availableSchemas.Clear();
        _availableTables.Clear();
        _sourceDatabase = "";
        _sourceSchema = "";
        _sourceTable = "";

        if (!string.IsNullOrEmpty(_selectedPreset))
        {
            var preset = _connectionPresets.FirstOrDefault(p => p.Name == _selectedPreset);
            if (preset != null)
            {
                _sourceConnectionString = preset.ConnectionString;
                await LoadDatabasesAsync();
            }
        }
    }

    private async Task TestSourceConnection()
    {
        _isTestingConnection = true;
        _connectionTestMessage = null;
        _connectionTestSuccess = false;

        try
        {
            var connectionString = string.IsNullOrEmpty(_selectedPreset)
                ? _sourceConnectionString
                : _connectionPresets.FirstOrDefault(p => p.Name == _selectedPreset)?.ConnectionString ?? "";

            if (string.IsNullOrEmpty(connectionString))
            {
                _connectionTestMessage = "Please enter a connection string";
                return;
            }

            _connectionTestSuccess = MetadataService.TestConnection(connectionString);
            _connectionTestMessage = _connectionTestSuccess
                ? "✓ Connection successful"
                : "✗ Connection failed";

            if (_connectionTestSuccess)
            {
                _sourceConnectionString = connectionString;
                SaveToRecentConnections(connectionString);
                await LoadDatabasesAsync();
            }
        }
        catch (Exception ex)
        {
            _connectionTestSuccess = false;
            _connectionTestMessage = $"✗ Error: {ex.Message}";
        }
        finally
        {
            _isTestingConnection = false;
        }
    }

    private async Task LoadDatabasesAsync()
    {
        _isLoadingDatabases = true;
        _availableDatabases.Clear();
        _sourceDatabase = "";
        _sourceSchema = "";
        _sourceTable = "";

        try
        {
            var databases = await MetadataService.GetDatabasesAsync(_sourceConnectionString);

            // Add default databases if configured
            var defaultDatabases = Configuration.GetSection("DefaultDatabases").Get<List<string>>() ?? new();
            _availableDatabases = databases.Union(defaultDatabases).Distinct().OrderBy(d => d).ToList();
        }
        catch (Exception ex)
        {
            _connectionTestMessage = $"✗ Error loading databases: {ex.Message}";
            _connectionTestSuccess = false;
        }
        finally
        {
            _isLoadingDatabases = false;
        }
    }

    private async Task OnDatabaseChanged()
    {
        _availableSchemas.Clear();
        _availableTables.Clear();
        _sourceSchema = "";
        _sourceTable = "";

        if (string.IsNullOrEmpty(_sourceDatabase))
            return;

        _isLoadingSchemas = true;

        try
        {
            _availableSchemas = await MetadataService.GetSchemasAsync(_sourceConnectionString, _sourceDatabase);

            // Pre-select "dbo" if available
            if (_availableSchemas.Contains("dbo"))
            {
                _sourceSchema = "dbo";
                await OnSchemaChanged();
            }
        }
        catch (Exception ex)
        {
            _connectionTestMessage = $"✗ Error loading schemas: {ex.Message}";
        }
        finally
        {
            _isLoadingSchemas = false;
        }
    }

    private async Task OnSchemaChanged()
    {
        _availableTables.Clear();
        _sourceTable = "";
        _tableSearchText = ""; // Clear search when schema changes

        if (string.IsNullOrEmpty(_sourceSchema))
            return;

        _isLoadingTables = true;

        try
        {
            _availableTables = await MetadataService.GetTablesAsync(_sourceConnectionString, _sourceDatabase, _sourceSchema);
        }
        catch (Exception ex)
        {
            _connectionTestMessage = $"✗ Error loading tables: {ex.Message}";
        }
        finally
        {
            _isLoadingTables = false;
        }
    }

    // Destination dropdown methods
    private async Task OnDestPresetChanged()
    {
        _destConnectionTestMessage = null;
        _destConnectionTestSuccess = false;
        _destAvailableDatabases.Clear();
        _destAvailableSchemas.Clear();
        _destAvailableTables.Clear();
        _destDatabase = "";
        _destSchema = "";
        _destTable = "";

        if (!string.IsNullOrEmpty(_destSelectedPreset))
        {
            var preset = _connectionPresets.FirstOrDefault(p => p.Name == _destSelectedPreset);
            if (preset != null)
            {
                _destConnectionString = preset.ConnectionString;
                await LoadDestDatabasesAsync();
            }
        }
    }

    private async Task TestDestConnection()
    {
        _isTestingDestConnection = true;
        _destConnectionTestMessage = null;
        _destConnectionTestSuccess = false;

        try
        {
            var connectionString = string.IsNullOrEmpty(_destSelectedPreset)
                ? _destConnectionString
                : _connectionPresets.FirstOrDefault(p => p.Name == _destSelectedPreset)?.ConnectionString ?? "";

            if (string.IsNullOrEmpty(connectionString))
            {
                _destConnectionTestMessage = "Please enter a connection string";
                return;
            }

            _destConnectionTestSuccess = MetadataService.TestConnection(connectionString);
            _destConnectionTestMessage = _destConnectionTestSuccess
                ? "✓ Connection successful"
                : "✗ Connection failed";

            if (_destConnectionTestSuccess)
            {
                _destConnectionString = connectionString;
                await LoadDestDatabasesAsync();
            }
        }
        catch (Exception ex)
        {
            _destConnectionTestSuccess = false;
            _destConnectionTestMessage = $"✗ Error: {ex.Message}";
        }
        finally
        {
            _isTestingDestConnection = false;
        }
    }

    private async Task LoadDestDatabasesAsync()
    {
        _isLoadingDestDatabases = true;
        _destAvailableDatabases.Clear();
        _destDatabase = "";
        _destSchema = "";
        _destTable = "";

        try
        {
            var databases = await MetadataService.GetDatabasesAsync(_destConnectionString);
            var defaultDatabases = Configuration.GetSection("DefaultDatabases").Get<List<string>>() ?? new();
            _destAvailableDatabases = databases.Union(defaultDatabases).Distinct().OrderBy(d => d).ToList();
        }
        catch (Exception ex)
        {
            _destConnectionTestMessage = $"✗ Error loading databases: {ex.Message}";
            _destConnectionTestSuccess = false;
        }
        finally
        {
            _isLoadingDestDatabases = false;
        }
    }

    private async Task OnDestDatabaseChanged()
    {
        _destAvailableSchemas.Clear();
        _destAvailableTables.Clear();
        _destSchema = "";
        _destTable = "";

        if (string.IsNullOrEmpty(_destDatabase))
            return;

        _isLoadingDestSchemas = true;

        try
        {
            _destAvailableSchemas = await MetadataService.GetSchemasAsync(_destConnectionString, _destDatabase);

            // Pre-select "dbo" if available
            if (_destAvailableSchemas.Contains("dbo"))
            {
                _destSchema = "dbo";
                await OnDestSchemaChanged();
            }
        }
        catch (Exception ex)
        {
            _destConnectionTestMessage = $"✗ Error loading schemas: {ex.Message}";
        }
        finally
        {
            _isLoadingDestSchemas = false;
        }
    }

    private async Task OnDestSchemaChanged()
    {
        _destAvailableTables.Clear();
        _destTable = "";

        if (string.IsNullOrEmpty(_destSchema))
            return;

        _isLoadingDestTables = true;

        try
        {
            _destAvailableTables = await MetadataService.GetTablesAsync(_destConnectionString, _destDatabase, _destSchema);
        }
        catch (Exception ex)
        {
            _destConnectionTestMessage = $"✗ Error loading tables: {ex.Message}";
        }
        finally
        {
            _isLoadingDestTables = false;
        }
    }

    private async Task HandleSubmit()
    {
        _isProcessing = true;
        _resultMessage = null;
        _currentTransferId = Guid.NewGuid().ToString();

        try
        {
            // Build configuration from form fields
            _config.Source = new SourceConfiguration();
            _config.Destination = new DestinationConfiguration();

            // Configure source
            if (_config.TransferType == TransferType.SqlToParquet)
            {
                _config.Source.Type = SourceType.SqlServer;
                _config.Source.ConnectionString = _sourceConnectionString;
                _config.Source.Table = new TableIdentifier
                {
                    Database = _sourceDatabase,
                    Schema = _sourceSchema,
                    Table = _sourceTable
                };
            }
            else
            {
                _config.Source.Type = SourceType.Parquet;
                _config.Source.ParquetPath = _sourceParquetPath;
            }

            // Configure destination
            if (_config.TransferType == TransferType.ParquetToSql)
            {
                _config.Destination.Type = DestinationType.SqlServer;
                _config.Destination.ConnectionString = _destConnectionString;
                _config.Destination.Table = new TableIdentifier
                {
                    Database = _destDatabase,
                    Schema = _destSchema,
                    Table = _destTable
                };
            }
            else
            {
                _config.Destination.Type = DestinationType.Parquet;
                // Ensure .parquet extension
                var parquetPath = _destParquetPath;
                if (!string.IsNullOrEmpty(parquetPath) && !parquetPath.EndsWith(".parquet", StringComparison.OrdinalIgnoreCase))
                {
                    parquetPath += ".parquet";
                }
                _config.Destination.ParquetPath = parquetPath;
            }

            var result = await ExecutionService.ExecuteAsync(_config, _currentTransferId);

            _transferSuccess = result.Success;
            _resultMessage = result.Success
                ? $"Successfully transferred {result.RowsLoaded:N0} rows in {result.Duration.TotalSeconds:F2} seconds"
                : $"Transfer failed: {result.ErrorMessage}";

            if (result.Success)
            {
                await Task.Delay(2000);
                Navigation.NavigateTo("/history");
            }
        }
        catch (Exception ex)
        {
            _transferSuccess = false;
            _resultMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
        }
    }

    // Profile management methods
    private async Task OnProfileSelected()
    {
        if (string.IsNullOrEmpty(_selectedProfileId))
        {
            return;
        }

        var profile = await ProfileService.GetProfileAsync(_selectedProfileId);
        if (profile == null)
        {
            return;
        }

        // Load configuration from profile
        _config = profile.Configuration;

        // Populate form fields based on transfer type
        if (profile.Configuration.TransferType == TransferType.SqlToParquet)
        {
            _sourceConnectionString = profile.Configuration.Source.ConnectionString ?? "";
            if (profile.Configuration.Source.Table != null)
            {
                _sourceDatabase = profile.Configuration.Source.Table.Database;
                _sourceSchema = profile.Configuration.Source.Table.Schema;
                _sourceTable = profile.Configuration.Source.Table.Table;
            }

            _destParquetPath = profile.Configuration.Destination.ParquetPath ?? "";
        }
        else if (profile.Configuration.TransferType == TransferType.ParquetToSql)
        {
            _sourceParquetPath = profile.Configuration.Source.ParquetPath ?? "";
            RefreshParquetFiles();

            _destConnectionString = profile.Configuration.Destination.ConnectionString ?? "";
            if (profile.Configuration.Destination.Table != null)
            {
                _destDatabase = profile.Configuration.Destination.Table.Database;
                _destSchema = profile.Configuration.Destination.Table.Schema;
                _destTable = profile.Configuration.Destination.Table.Table;
            }
        }

        StateHasChanged();
    }

    private void ShowSaveProfileDialog()
    {
        _showSaveProfileDialog = true;
        _newProfileName = "";
        _newProfileDescription = null;
        _newProfileTags = null;
        _profileSaveMessage = null;
    }

    private void CloseSaveProfileDialog()
    {
        _showSaveProfileDialog = false;
        _profileSaveMessage = null;
    }

    private async Task SaveProfile()
    {
        try
        {
            // Parse tags
            var tags = string.IsNullOrWhiteSpace(_newProfileTags)
                ? new List<string>()
                : _newProfileTags.Split(',').Select(t => t.Trim()).Where(t => !string.IsNullOrEmpty(t)).ToList();

            // Build current configuration
            BuildConfigurationFromForm();

            // Save profile
            await ProfileService.SaveProfileAsync(_newProfileName, _newProfileDescription, _config, "web-user", tags);

            _profileSaveSuccess = true;
            _profileSaveMessage = $"Profile '{_newProfileName}' saved successfully!";

            // Reload profiles list
            _availableProfiles = await ProfileService.GetAllProfilesAsync();

            // Close dialog after short delay
            await Task.Delay(1500);
            CloseSaveProfileDialog();
        }
        catch (Exception ex)
        {
            _profileSaveSuccess = false;
            _profileSaveMessage = $"Error saving profile: {ex.Message}";
        }
    }

    private void BuildConfigurationFromForm()
    {
        // This method is called from SaveProfile to capture current form state
        // Configure source
        if (_config.TransferType == TransferType.SqlToParquet)
        {
            _config.Source.Type = SourceType.SqlServer;
            _config.Source.ConnectionString = _sourceConnectionString;
            _config.Source.Table = new TableIdentifier
            {
                Database = _sourceDatabase,
                Schema = _sourceSchema,
                Table = _sourceTable
            };
        }
        else
        {
            _config.Source.Type = SourceType.Parquet;
            _config.Source.ParquetPath = _sourceParquetPath;
        }

        // Configure destination
        if (_config.TransferType == TransferType.ParquetToSql)
        {
            _config.Destination.Type = DestinationType.SqlServer;
            _config.Destination.ConnectionString = _destConnectionString;
            _config.Destination.Table = new TableIdentifier
            {
                Database = _destDatabase,
                Schema = _destSchema,
                Table = _destTable
            };
        }
        else
        {
            _config.Destination.Type = DestinationType.Parquet;
            var parquetPath = _destParquetPath;
            if (!string.IsNullOrEmpty(parquetPath) && !parquetPath.EndsWith(".parquet", StringComparison.OrdinalIgnoreCase))
            {
                parquetPath += ".parquet";
            }
            _config.Destination.ParquetPath = parquetPath;
        }
    }
}
